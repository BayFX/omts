{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://omtsf.org/schema/omts-v0.1.0.schema.json",
  "title": "OMTSF .omts File Format",
  "description": "JSON Schema for the Open Multi-Tier Supply-chain Framework file format, version 0.1.0. Covers SPEC-001 (Graph Data Model), SPEC-002 (Entity Identification), SPEC-003 (Merge Semantics), and SPEC-004 (Selective Disclosure).",
  "type": "object",
  "required": ["omtsf_version", "snapshot_date", "file_salt", "nodes", "edges"],
  "properties": {
    "omtsf_version": {
      "type": "string",
      "description": "Semantic version of the OMTSF specification (e.g., \"0.1.0\"). MUST be the first key in serialized JSON for file-type detection.",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "snapshot_date": {
      "type": "string",
      "description": "ISO 8601 calendar date when this graph snapshot was produced.",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
    },
    "file_salt": {
      "type": "string",
      "description": "64-character lowercase hexadecimal string (32 bytes) generated by a CSPRNG. Used for boundary reference hashing (SPEC-004).",
      "pattern": "^[0-9a-f]{64}$"
    },
    "disclosure_scope": {
      "$ref": "#/$defs/disclosure_scope"
    },
    "previous_snapshot_ref": {
      "type": "string",
      "description": "SHA-256 hash (hex-encoded) or URI of the prior snapshot this file supersedes."
    },
    "snapshot_sequence": {
      "type": "integer",
      "minimum": 0,
      "description": "Monotonically increasing sequence number for ordering successive snapshots from the same producer."
    },
    "update_type": {
      "type": "string",
      "enum": ["snapshot", "delta"],
      "description": "File type: 'snapshot' (default, full graph) or 'delta' (incremental patch)."
    },
    "base_snapshot_ref": {
      "type": "string",
      "description": "SHA-256 hash (hex-encoded) or URI of the base snapshot a delta applies to. Required when update_type is 'delta'."
    },
    "nodes": {
      "type": "array",
      "description": "Array of node objects representing supply chain entities.",
      "items": {
        "$ref": "#/$defs/node"
      }
    },
    "edges": {
      "type": "array",
      "description": "Array of edge objects representing relationships between nodes.",
      "items": {
        "$ref": "#/$defs/edge"
      }
    },
    "file_integrity": {
      "$ref": "#/$defs/file_integrity"
    },
    "merge_metadata": {
      "$ref": "#/$defs/merge_metadata"
    }
  },
  "if": {
    "properties": {
      "update_type": { "const": "delta" }
    },
    "required": ["update_type"]
  },
  "then": {
    "required": ["base_snapshot_ref"]
  },
  "additionalProperties": true,
  "$defs": {

    "iso_8601_date": {
      "type": "string",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
      "description": "ISO 8601 calendar date in YYYY-MM-DD format."
    },

    "iso_8601_date_nullable": {
      "oneOf": [
        { "$ref": "#/$defs/iso_8601_date" },
        { "type": "null" }
      ],
      "description": "ISO 8601 calendar date or null (null means open-ended / no expiration)."
    },

    "disclosure_scope": {
      "type": "string",
      "enum": ["internal", "partner", "public"],
      "description": "Intended audience for the file: internal (originating org only), partner (direct trading partners), or public (unrestricted)."
    },

    "identifier_sensitivity": {
      "type": "string",
      "enum": ["public", "restricted", "confidential"],
      "description": "Sensitivity classification for an identifier record."
    },

    "verification_status": {
      "type": "string",
      "enum": ["verified", "reported", "inferred", "unverified"],
      "description": "Verification status of an identifier: verified (confirmed against authoritative source), reported (provided by entity), inferred (derived by tooling), unverified (no verification attempted)."
    },

    "identifier_record": {
      "type": "object",
      "description": "An external identifier record as defined in SPEC-002, Section 3.",
      "required": ["scheme", "value"],
      "properties": {
        "scheme": {
          "type": "string",
          "minLength": 1,
          "description": "Identifier scheme code: a core scheme (lei, duns, gln, nat-reg, vat, internal, opaque) or an extension scheme in reverse-domain notation."
        },
        "value": {
          "type": "string",
          "minLength": 1,
          "description": "The identifier value within the scheme."
        },
        "authority": {
          "type": "string",
          "minLength": 1,
          "description": "Issuing authority or jurisdiction qualifier. Required for nat-reg, vat, and internal schemes."
        },
        "valid_from": {
          "$ref": "#/$defs/iso_8601_date",
          "description": "Date this identifier became effective for this entity."
        },
        "valid_to": {
          "$ref": "#/$defs/iso_8601_date_nullable",
          "description": "Date this identifier ceased to be valid. null means currently valid."
        },
        "sensitivity": {
          "$ref": "#/$defs/identifier_sensitivity"
        },
        "verification_status": {
          "$ref": "#/$defs/verification_status"
        },
        "verification_date": {
          "$ref": "#/$defs/iso_8601_date",
          "description": "Date the identifier was last verified against an authoritative source."
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "scheme": { "const": "nat-reg" } },
            "required": ["scheme"]
          },
          "then": {
            "required": ["scheme", "value", "authority"]
          }
        },
        {
          "if": {
            "properties": { "scheme": { "const": "vat" } },
            "required": ["scheme"]
          },
          "then": {
            "required": ["scheme", "value", "authority"]
          }
        },
        {
          "if": {
            "properties": { "scheme": { "const": "internal" } },
            "required": ["scheme"]
          },
          "then": {
            "required": ["scheme", "value", "authority"]
          }
        }
      ],
      "additionalProperties": true
    },

    "data_quality": {
      "type": "object",
      "description": "Data quality metadata (SPEC-001, Section 8.3). Informational; validators MUST NOT reject files based on these values.",
      "properties": {
        "confidence": {
          "type": "string",
          "enum": ["verified", "reported", "inferred", "estimated"],
          "description": "Confidence level of the data."
        },
        "source": {
          "type": "string",
          "description": "Provenance description (e.g., 'gleif-api', 'supplier-questionnaire', 'manual-review')."
        },
        "last_verified": {
          "$ref": "#/$defs/iso_8601_date",
          "description": "Date the data was last verified against an authoritative source."
        }
      },
      "additionalProperties": true
    },

    "delta_operation": {
      "type": "string",
      "enum": ["add", "modify", "remove"],
      "description": "Delta operation type for incremental updates (SPEC-001, Section 12.2)."
    },

    "file_integrity": {
      "type": "object",
      "description": "File integrity metadata for tamper detection (SPEC-004, Section 6).",
      "properties": {
        "content_hash": {
          "type": "string",
          "description": "Hex-encoded SHA-256 hash of the canonical file content (RFC 8785, excluding file_integrity field).",
          "pattern": "^[0-9a-f]{64}$"
        },
        "algorithm": {
          "type": "string",
          "const": "sha-256",
          "description": "Hash algorithm. MUST be 'sha-256'."
        },
        "signature": {
          "type": "string",
          "description": "Optional detached digital signature over content_hash, base64-encoded. Supported algorithms: Ed25519, ECDSA-P256."
        },
        "signer": {
          "type": "string",
          "description": "Identifier of the signing entity (e.g., LEI or domain name). Required when signature is present."
        }
      },
      "additionalProperties": true
    },

    "merge_metadata": {
      "type": "object",
      "description": "Merge provenance metadata (SPEC-003, Section 6).",
      "properties": {
        "source_file_hashes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[0-9a-f]{64}$"
          },
          "description": "SHA-256 hashes (hex-encoded) of each source file that contributed to this merge."
        },
        "merge_timestamp": {
          "type": "string",
          "description": "ISO 8601 date-time when the merge was performed."
        },
        "nodes_merged": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of nodes merged (deduplicated)."
        },
        "edges_merged": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of edges merged (deduplicated)."
        },
        "conflicts_detected": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of property conflicts detected during merge."
        },
        "contributor_id": {
          "type": "string",
          "description": "Identifier of the entity or system that performed the merge (e.g., LEI, domain name, system identifier)."
        },
        "signature": {
          "type": "string",
          "description": "Optional detached signature (base64-encoded) over merge_metadata (canonical JSON per RFC 8785, excluding the signature field). Supported algorithms: Ed25519, ECDSA-P256."
        }
      },
      "additionalProperties": true
    },

    "geo_point": {
      "type": "object",
      "description": "WGS 84 coordinate pair.",
      "required": ["lat", "lon"],
      "properties": {
        "lat": {
          "type": "number",
          "minimum": -90,
          "maximum": 90,
          "description": "Latitude in decimal degrees (WGS 84)."
        },
        "lon": {
          "type": "number",
          "minimum": -180,
          "maximum": 180,
          "description": "Longitude in decimal degrees (WGS 84)."
        }
      },
      "additionalProperties": false
    },

    "geo_object": {
      "description": "WGS 84 coordinates as a lat/lon point, or a GeoJSON geometry for polygon boundaries (EUDR land parcel traceability).",
      "oneOf": [
        { "$ref": "#/$defs/geo_point" },
        {
          "type": "object",
          "description": "GeoJSON geometry object (RFC 7946).",
          "required": ["type", "coordinates"],
          "properties": {
            "type": {
              "type": "string",
              "description": "GeoJSON geometry type."
            },
            "coordinates": {
              "description": "GeoJSON coordinates array."
            }
          },
          "additionalProperties": true
        }
      ]
    },

    "node": {
      "type": "object",
      "description": "A node in the OMTSF supply chain graph.",
      "required": ["id", "type", "name"],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "description": "Graph-local unique identifier for this node. Used for edge source/target references within the same file."
        },
        "type": {
          "type": "string",
          "minLength": 1,
          "description": "Node type: one of the core types (organization, facility, good, person, attestation, consignment, boundary_ref) or an extension type in reverse-domain notation."
        },
        "name": {
          "type": "string",
          "description": "Name or label of the entity."
        },
        "identifiers": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/identifier_record"
          },
          "description": "Array of external identifier records (SPEC-002)."
        },
        "data_quality": {
          "$ref": "#/$defs/data_quality"
        },
        "_operation": {
          "$ref": "#/$defs/delta_operation"
        },
        "_conflicts": {
          "type": "array",
          "description": "Merge conflict records (SPEC-003, Section 4). Informational.",
          "items": {
            "type": "object",
            "properties": {
              "field": { "type": "string" },
              "values": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "value": {},
                    "source_file": { "type": "string" }
                  },
                  "additionalProperties": true
                }
              }
            },
            "additionalProperties": true
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "organization" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "name": { "type": "string" },
              "jurisdiction": {
                "type": "string",
                "pattern": "^[A-Z]{2}$",
                "description": "ISO 3166-1 alpha-2 country code of incorporation or primary registration."
              },
              "status": {
                "type": "string",
                "enum": ["active", "dissolved", "merged", "suspended"],
                "description": "Entity lifecycle status."
              },
              "governance_structure": {
                "type": "string",
                "enum": ["sole_subsidiary", "joint_venture", "consortium", "cooperative"],
                "description": "Governance structure indicator for shared governance scenarios (e.g., CSDDD Article 22 joint venture obligations)."
              }
            },
            "required": ["name"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "facility" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "name": { "type": "string" },
              "operator": {
                "type": "string",
                "description": "Graph-local id of the organization node that operates this facility."
              },
              "address": {
                "type": "string",
                "description": "Structured or free-text address."
              },
              "geo": {
                "$ref": "#/$defs/geo_object"
              }
            },
            "required": ["name"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "good" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "name": { "type": "string" },
              "commodity_code": {
                "type": "string",
                "description": "HS or CN commodity code."
              },
              "unit": {
                "type": "string",
                "description": "Unit of measure (e.g., kg, mt, pcs)."
              }
            },
            "required": ["name"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "person" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "name": { "type": "string" },
              "jurisdiction": {
                "type": "string",
                "pattern": "^[A-Z]{2}$",
                "description": "ISO 3166-1 alpha-2 country code of nationality or primary residence."
              },
              "role": {
                "type": "string",
                "description": "Free-text description of the person's role (e.g., 'Ultimate Beneficial Owner', 'Director')."
              }
            },
            "required": ["name"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "attestation" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "name": { "type": "string" },
              "attestation_type": {
                "type": "string",
                "enum": ["certification", "audit", "due_diligence_statement", "self_declaration", "other"],
                "description": "Type of attestation."
              },
              "standard": {
                "type": "string",
                "description": "The standard or framework (e.g., SA8000, ISO 14001, SMETA, EUDR-DDS)."
              },
              "issuer": {
                "type": "string",
                "description": "Name of the issuing or certifying body."
              },
              "valid_from": {
                "$ref": "#/$defs/iso_8601_date",
                "description": "Date the attestation became effective."
              },
              "valid_to": {
                "$ref": "#/$defs/iso_8601_date_nullable",
                "description": "Expiration date. null means no expiration."
              },
              "outcome": {
                "type": "string",
                "enum": ["pass", "conditional_pass", "fail", "pending", "not_applicable"],
                "description": "Attestation outcome."
              },
              "status": {
                "type": "string",
                "enum": ["active", "suspended", "revoked", "expired", "withdrawn"],
                "description": "Attestation lifecycle state."
              },
              "reference": {
                "type": "string",
                "description": "Document reference number or URI."
              },
              "risk_severity": {
                "type": "string",
                "enum": ["critical", "high", "medium", "low"],
                "description": "Risk severity classification for CSDDD Article 7 risk-prioritized due diligence."
              },
              "risk_likelihood": {
                "type": "string",
                "enum": ["very_likely", "likely", "possible", "unlikely"],
                "description": "Likelihood of the identified risk for risk matrix prioritization."
              }
            },
            "required": ["name", "attestation_type", "valid_from"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "consignment" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "name": { "type": "string" },
              "lot_id": {
                "type": "string",
                "description": "Lot or batch number."
              },
              "quantity": {
                "type": "number",
                "description": "Quantity in the specified unit."
              },
              "unit": {
                "type": "string",
                "description": "Unit of measure (e.g., kg, mt, pcs)."
              },
              "production_date": {
                "$ref": "#/$defs/iso_8601_date",
                "description": "Date the consignment was produced or harvested."
              },
              "origin_country": {
                "type": "string",
                "pattern": "^[A-Z]{2}$",
                "description": "ISO 3166-1 alpha-2 country code of origin."
              },
              "direct_emissions_co2e": {
                "type": "number",
                "description": "Direct (Scope 1) embedded emissions in tonnes CO2 equivalent (CBAM)."
              },
              "indirect_emissions_co2e": {
                "type": "number",
                "description": "Indirect (Scope 2) embedded emissions in tonnes CO2 equivalent (CBAM)."
              },
              "emission_factor_source": {
                "type": "string",
                "enum": ["actual", "default_eu", "default_country"],
                "description": "Source of emissions data: actual (installation-level), default_eu (EU defaults per Annex III), default_country (third-country defaults)."
              },
              "installation_id": {
                "type": "string",
                "description": "Graph-local id of the facility node representing the producing installation."
              }
            },
            "required": ["name"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "boundary_ref" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "type": { "const": "boundary_ref" },
              "name": { "type": "string" },
              "identifiers": {
                "type": "array",
                "items": {
                  "$ref": "#/$defs/identifier_record"
                },
                "minItems": 1,
                "maxItems": 1,
                "description": "Exactly one identifier with scheme 'opaque'."
              }
            },
            "required": ["id", "type", "identifiers"]
          }
        }
      ],
      "patternProperties": {
        "^[a-z]{2,}\\.[a-z0-9.-]+\\..+$": {
          "description": "Extension properties using reverse-domain notation."
        }
      },
      "additionalProperties": true
    },

    "edge": {
      "type": "object",
      "description": "An edge in the OMTSF supply chain graph. Structural fields (id, type, source, target) are top-level; all relationship-specific properties are inside the 'properties' wrapper.",
      "required": ["id", "type", "source", "target"],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "description": "Graph-local unique identifier for this edge."
        },
        "type": {
          "type": "string",
          "minLength": 1,
          "description": "Edge type: one of the 15 core types, 'same_as' (SPEC-003), or an extension type in reverse-domain notation."
        },
        "source": {
          "type": "string",
          "minLength": 1,
          "description": "Graph-local id of the source node."
        },
        "target": {
          "type": "string",
          "minLength": 1,
          "description": "Graph-local id of the target node."
        },
        "properties": {
          "type": "object",
          "description": "Wrapper object for all edge-specific properties (SPEC-001, Section 2.1).",
          "additionalProperties": true
        },
        "identifiers": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/identifier_record"
          },
          "description": "Optional external identifiers for cross-file edge merge."
        },
        "_operation": {
          "$ref": "#/$defs/delta_operation"
        },
        "_conflicts": {
          "type": "array",
          "description": "Merge conflict records (SPEC-003, Section 4). Informational.",
          "items": {
            "type": "object",
            "properties": {
              "field": { "type": "string" },
              "values": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "value": {},
                    "source_file": { "type": "string" }
                  },
                  "additionalProperties": true
                }
              }
            },
            "additionalProperties": true
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "ownership" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["percentage", "valid_from"],
                "properties": {
                  "percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Ownership percentage. 0 indicates known relationship with unknown percentage."
                  },
                  "direct": {
                    "type": "boolean",
                    "description": "true if direct ownership, false if indirect. Default: true."
                  },
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "operational_control" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["control_type", "valid_from"],
                "properties": {
                  "control_type": {
                    "type": "string",
                    "enum": ["franchise", "management", "tolling", "licensed_manufacturing", "other"],
                    "description": "Type of operational control."
                  },
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "legal_parentage" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "consolidation_basis": {
                    "type": "string",
                    "enum": ["ifrs10", "us_gaap_asc810", "other", "unknown"],
                    "description": "Accounting consolidation basis. Maps to GLEIF Level 2 IS_DIRECTLY_CONSOLIDATED_BY."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "former_identity" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["event_type", "effective_date"],
                "properties": {
                  "event_type": {
                    "type": "string",
                    "enum": ["merger", "acquisition", "rename", "demerger", "spin_off"],
                    "description": "Type of identity transformation event."
                  },
                  "effective_date": {
                    "$ref": "#/$defs/iso_8601_date",
                    "description": "Date the event took effect."
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable description of the event."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "beneficial_ownership" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["control_type", "valid_from"],
                "properties": {
                  "percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Ownership percentage. Omit if unknown."
                  },
                  "control_type": {
                    "type": "string",
                    "enum": ["voting_rights", "capital", "other_means", "senior_management"],
                    "description": "Type of beneficial ownership control."
                  },
                  "direct": {
                    "type": "boolean",
                    "description": "true if direct ownership, false if through intermediary entities. Default: true."
                  },
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "supplies" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "commodity": {
                    "type": "string",
                    "description": "HS code or free-text description of what is supplied."
                  },
                  "contract_ref": {
                    "type": "string",
                    "description": "Reference to a contract or purchase agreement."
                  },
                  "volume": {
                    "type": "number",
                    "description": "Volume or quantity supplied per period."
                  },
                  "volume_unit": {
                    "type": "string",
                    "description": "Unit of measure for volume (e.g., kg, mt, pcs, units)."
                  },
                  "annual_value": {
                    "type": "number",
                    "description": "Annual monetary value of the supply relationship."
                  },
                  "value_currency": {
                    "type": "string",
                    "pattern": "^[A-Z]{3}$",
                    "description": "ISO 4217 currency code for annual_value."
                  },
                  "tier": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Supply chain tier relative to the reporting entity (1 = direct, 2 = tier 2, etc.)."
                  },
                  "share_of_buyer_demand": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Percentage of buyer's total demand for this commodity fulfilled by this supplier."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "subcontracts" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "commodity": {
                    "type": "string",
                    "description": "What is subcontracted."
                  },
                  "contract_ref": {
                    "type": "string",
                    "description": "Subcontracting agreement reference."
                  },
                  "volume": {
                    "type": "number",
                    "description": "Volume or quantity supplied per period."
                  },
                  "volume_unit": {
                    "type": "string",
                    "description": "Unit of measure for volume."
                  },
                  "share_of_buyer_demand": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Percentage of contracting entity's demand fulfilled by this subcontractor."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "tolls" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "commodity": {
                    "type": "string",
                    "description": "Material being tolled/processed."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "distributes" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "service_type": {
                    "type": "string",
                    "enum": ["warehousing", "transport", "fulfillment", "other"],
                    "description": "Type of distribution service."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "brokers" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "commodity": {
                    "type": "string",
                    "description": "What is brokered."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "operates" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "produces" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "composed_of" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "properties": {
                  "quantity": {
                    "type": "number",
                    "description": "Quantity of the component per unit of the parent good."
                  },
                  "unit": {
                    "type": "string",
                    "description": "Unit of measure for quantity."
                  },
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "sells_to" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "required": ["valid_from"],
                "properties": {
                  "valid_from": {
                    "$ref": "#/$defs/iso_8601_date"
                  },
                  "valid_to": {
                    "$ref": "#/$defs/iso_8601_date_nullable"
                  },
                  "commodity": {
                    "type": "string",
                    "description": "HS code or description."
                  },
                  "contract_ref": {
                    "type": "string",
                    "description": "Contract or sales agreement reference."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "attested_by" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "properties": {
                  "scope": {
                    "type": "string",
                    "description": "Aspect the attestation covers. Recommended values: labor_rights, environmental, deforestation_free, carbon_emissions, health_safety, anti_corruption, conflict_minerals, other. Free-text permitted."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "same_as" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "properties": {
                "type": "object",
                "properties": {
                  "confidence": {
                    "type": "string",
                    "enum": ["definite", "probable", "possible"],
                    "description": "Confidence level of the same-as assertion. Default: probable."
                  },
                  "basis": {
                    "type": "string",
                    "description": "Justification for the equivalence assertion (e.g., name_match, address_match, manual_review)."
                  },
                  "data_quality": {
                    "$ref": "#/$defs/data_quality"
                  },
                  "_property_sensitivity": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/identifier_sensitivity"
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          }
        }
      ],
      "patternProperties": {
        "^[a-z]{2,}\\.[a-z0-9.-]+\\..+$": {
          "description": "Extension edge types using reverse-domain notation."
        }
      },
      "additionalProperties": true
    }
  }
}
